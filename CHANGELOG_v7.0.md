# v7.0 更新日志

## v7.0.2 (2025-12-29)

### 移除黄金数据展示
- **原因**：yfinance API 频繁限流导致数据不稳定，显示默认值用户体验差
- **修改**：隐藏前端黄金卡片，保留后端数据逻辑
- **影响**：市场概览从 4 个卡片减少到 3 个（A股、美股、领涨板块）
- **恢复方式**：如需恢复，编辑 `components/market-header.tsx` 取消注释黄金卡片代码块

### 布局优化
- 网格布局从 `lg:grid-cols-4` 调整为 `lg:grid-cols-3`
- 响应式布局保持不变：移动端1列，平板2列，桌面3列

---

## v7.0.1 (2025-12-29)

### 黄金数据获取优化
- **新增**：优先从数据库读取上海金交所数据（Au99.99）
- **优化**：增加 yfinance API 调用延迟（5秒）避免限流
- **改进**：三层备用机制（数据库 → 伦敦金 → 黄金期货 → GLD ETF → 默认值）

### 数据点不足自动修复
- **新增**：自动检测 sparkline 数据点 < 20 的资产
- **修复**：自动触发重新初始化，无需手动干预
- **优化**：降低初始化要求从 `>1` 改为 `>0`

---

## v7.0.0 (2025-12-29)

### 趋势图增量追加模式 🚀

**核心改进**：彻底重构趋势图更新逻辑，从"全量拉取"改为"增量追加"

#### 主要变更

1. **新增 `append_to_sparkline` 方法** (`etl.py`)
   - 实现增量追加核心逻辑
   - 自动去重（同一天覆盖而非重复）
   - 滑动窗口裁剪（保持最近 250 天）
   - JSON 解析异常保护

2. **新增 `get_existing_sparkline` 方法** (`etl.py`)
   - 从数据库读取已有趋势图数据
   - 自动处理空值和异常情况

3. **智能路由逻辑**
   ```
   IF 数据库有历史数据:
       ✅ 增量模式：只追加今日数据点（不调用 Tushare API）
   ELSE:
       🔄 全量模式：调用 API 初始化历史数据（仅首次）
   ```

#### 优势

- ✅ **稳定性大幅提升**：每日更新不再依赖 Tushare 全量拉取
- ✅ **性能优化**：更新速度更快（1 个点 vs 250 天）
- ✅ **节省 API 配额**：减少 95% 的 API 调用
- ✅ **数据一致性**：自动去重和裁剪机制

#### 修复脚本

- **新增**：`scripts/fix_sparkline_v7.py` - 一键修复所有资产的趋势图数据
- **新增**：`run_etl.bat` - Windows 批处理快捷方式

#### 文档

- **新增**：`v7.0_troubleshooting.md` - 完整的问题排查与修复指南

---

## 下一步计划

- [ ] 考虑添加其他避险资产数据（如比特币、美债）
- [ ] 优化 API 重试机制
- [ ] 添加数据监控告警
- [ ] 定时任务自动化（GitHub Actions）

---

**版本**：v7.0.2  
**日期**：2025-12-29  
**作者**：AI Assistant  
**状态**：✅ 已部署

