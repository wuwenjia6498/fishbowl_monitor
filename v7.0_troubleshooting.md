# v7.0 趋势图问题排查与修复指南

## 问题现象
前端显示"近期趋势(90D)"列为空白（暂无数据）

## 问题原因分析

v7.0 的增量追加模式有以下逻辑：
1. **增量模式**：如果数据库有旧的 sparkline_json → 只追加今日数据
2. **全量模式**：如果数据库没有旧数据 → 调用 Tushare 初始化历史数据

**问题**：首次初始化时，可能因为以下原因导致 sparkline 数据未成功保存：
- 历史数据获取失败
- 数据点数量不足（之前要求 >1个点，现已修改为 >0个点）
- API 限流或非交易日

## 解决方案

### 方案一：运行修复脚本（推荐）

在项目根目录执行：

```bash
python scripts/fix_sparkline_v7.py
```

**功能**：
- 检查所有资产的 sparkline_json 状态
- 对于数据为空的资产，重新获取历史数据并生成趋势图
- 已有数据的资产自动跳过

### 方案二：重新运行 ETL 脚本

```bash
python scripts/etl.py
```

**注意**：v7.0 改进后的ETL会：
- 自动检测哪些资产缺少 sparkline 数据
- 只对缺失数据的资产进行全量初始化
- 已有数据的资产使用增量追加模式

### 方案三：数据库直接检查

运行诊断脚本：

```bash
# Node.js 版本（如果 Python 路径有问题）
node scripts/quick-check-sparkline.js

# Python 版本
python scripts/verify_sparkline.py
```

## 验证修复效果

### 1. 检查数据库

```sql
SELECT 
    symbol,
    CASE 
        WHEN sparkline_json IS NULL THEN '❌ NULL'
        WHEN jsonb_array_length(sparkline_json) = 0 THEN '⚠️ 空数组'
        ELSE '✅ 有数据 (' || jsonb_array_length(sparkline_json)::text || ' 个点)'
    END as status
FROM fishbowl_daily
WHERE date = (SELECT MAX(date) FROM fishbowl_daily)
ORDER BY symbol
LIMIT 10;
```

### 2. 检查前端

访问 http://localhost:3000，查看"近期趋势(90D)"列是否显示趋势图。

## v7.0 改进内容

### 代码修改

1. **降低初始化要求** (`etl.py` 第1153行)
   ```python
   # 修改前：if len(sparkline_array) > 1:
   # 修改后：if len(sparkline_array) > 0:
   ```

2. **增加调试信息**
   ```python
   print(f"      历史数据总行数: {len(result_df)}")
   ```

3. **异常保护增强**
   - JSON 解析失败 → 重置为空数组并初始化
   - 数据库查询失败 → 触发全量模式
   - 追加失败 → 保留旧数据

### 核心逻辑

```
for each 资产:
    查询数据库中的 sparkline_json
    
    if 有旧数据:
        ✅ 增量模式：只追加今日数据点
        - 不调用 Tushare API（节省配额）
        - 自动去重（同一天覆盖）
        - 滑动窗口裁剪（保持250天）
    else:
        🔄 全量模式：调用 API 初始化
        - 获取365天历史数据
        - 生成完整 sparkline
        - 只在首次或数据丢失时执行
```

## 常见问题

### Q1: 为什么有些资产有数据，有些没有？
**A**: 可能是部分资产在首次初始化时 API 调用失败。运行修复脚本即可。

### Q2: 修复后还是看不到趋势图？
**A**: 检查以下几点：
1. 浏览器缓存（Ctrl+F5 强制刷新）
2. 数据库连接是否正常
3. 前端API是否正确读取 sparkline_json 字段

### Q3: 增量追加会不会导致数据重复？
**A**: 不会。代码有去重逻辑：
```python
if last_date == today_date:
    # 同一天，更新（覆盖）最后一个点
    current_chart[-1] = new_point
```

### Q4: 如何确认增量追加模式是否生效？
**A**: 查看 ETL 运行日志：
- 显示 "📊 [符号] 增量追加模式" → 增量模式（不调用API）
- 显示 "🔄 [符号] 首次初始化" → 全量模式（调用API）

## 下一步优化建议

1. **定时任务**：设置每天自动运行 ETL（如 GitHub Actions 或 cron）
2. **监控告警**：sparkline 数据异常时发送通知
3. **数据备份**：定期备份 sparkline_json 数据
4. **API 重试**：增加失败重试机制

---

**版本**：v7.0 Stability Upgrade  
**日期**：2025-12-29  
**状态**：✅ 已修复，待用户验证

