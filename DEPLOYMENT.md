# 鱼盆趋势雷达 v3.1 部署指南

## 升级内容

本次升级实现了：
1. ✅ 二级行业下沉（L1 + L2申万行业）
2. ✅ 行业 -> 龙头ETF 映射系统
3. ✅ ETF 交易辅助（点击复制代码）
4. ✅ 双维气候看板（宽基大势 + 行业赚钱效应）

---

## 部署步骤

### 1. 数据库升级

在 Supabase SQL Editor 中执行：

```bash
# 运行建表脚本
cat sql/schema.sql
```

这将：
- 创建新的表结构（包含 `industry_level` 和 `dominant_etf` 字段）
- 初始化宽基指数数据

### 2. 安装 Python 依赖

```bash
pip install tushare pandas psycopg2-binary python-dotenv
```

### 3. 配置环境变量

确保 `.env` 文件包含：

```env
DATABASE_URL=your_supabase_connection_string
TUSHARE_TOKEN=your_tushare_token
```

### 4. 初始化行业数据

运行初始化脚本（包含60+个热门ETF映射）：

```bash
python scripts/init_db.py
```

输出示例：
```
============================================================
鱼盆趋势雷达 - 数据库初始化 v3.1
============================================================
✓ 数据库连接成功
正在获取申万行业指数列表...
✓ 获取到 XXX 条行业指数
✓ 成功写入 XXX 条行业指数
✓ 其中 XX 条已激活监控
✓ 其中 XX 条关联了龙头 ETF

============================================================
初始化完成！数据统计：
  - 宽基指数: 9 个
  - 行业指数: XXX 个
  - 关联ETF: XX 个
============================================================
```

### 5. 每日数据更新

运行 ETL 脚本获取最新数据：

```bash
python scripts/etl.py
```

输出示例：
```
============================================================
鱼盆趋势雷达 - ETL 更新 v3.1
============================================================
✓ 找到 XX 个需要更新的指数
------------------------------------------------------------
  处理: 沪深300 (000300.SH)
  处理: 半导体 (801080.SI)
  ...
✓ 批量入库成功: XX 条记录
✓ 更新趋势排名完成: 2025-XX-XX

============================================================
ETL 更新完成！
  - 成功处理: XX/XX 个指数
  - 多头 (YES): XX
  - 空头 (NO): XX
  - 最新日期: 2025-XX-XX
============================================================
```

### 6. 启动前端

```bash
npm run dev
```

访问：http://localhost:3000

---

## 新功能使用指南

### 双维气候看板

**左侧 - 宽基大势：**
- 🔴 进攻 (Bull Market) - YES占比 > 60%
- 🟡 震荡 (Volatile) - YES占比 40-60%
- 🟢 防守 (Bear Market) - YES占比 < 40%

**右侧 - 赚钱效应：**
- 显示行业多头率百分比
- 进度条可视化展示

### 行业轮动 Tab

**新增 ETF 标的列：**
- 显示龙头ETF代码（如 512480）
- 点击代码自动复制到剪贴板
- Toast 提示复制成功

**板块名称增强：**
- 二级行业显示 "L2" 标签
- 方便区分行业层级

### 宽基大势 Tab

显示宽基指数的：
- 偏离度（恢复显示）
- ETF 操作建议（建仓/持有/空仓）

---

## ETF 映射字典

已内置 60+ 个热门行业 ETF，涵盖：

- 🔹 科技板块：半导体(512480)、消费电子(159732)、软件(515230)
- 🔹 金融板块：证券(512880)、银行(512800)、保险(512890)
- 🔹 消费板块：白酒(512690)、医疗(159772)、食品(159736)
- 🔹 新能源：光伏(515790)、电池(159755)、新能源车(516160)
- 🔹 周期板块：煤炭(515220)、钢铁(515210)、有色(512400)
- 🔹 军工(512660)、传媒(516010)、环保(512580)...

查看完整列表：`scripts/init_db.py` 中的 `ETF_MAPPING` 字典

---

## 定时任务设置（可选）

### Linux / macOS (crontab)

每日 18:00 自动更新数据：

```bash
crontab -e

# 添加以下行
0 18 * * 1-5 cd /path/to/fishbowl_monitor && /usr/bin/python3 scripts/etl.py >> logs/etl.log 2>&1
```

### Windows (任务计划程序)

1. 打开"任务计划程序"
2. 创建基本任务
3. 触发器：工作日 18:00
4. 操作：启动程序 `python scripts/etl.py`

---

## 故障排查

### Q: 数据库连接失败

**A:** 检查 `.env` 中的 `DATABASE_URL` 是否正确，确保包含 `?sslmode=require`

### Q: Tushare 数据获取失败

**A:**
1. 检查 `TUSHARE_TOKEN` 是否有效
2. 确认 Tushare 积分权限（申万指数需要一定积分）
3. 查看 [Tushare 官方文档](https://tushare.pro/document/2)

### Q: 前端显示错误

**A:** 确保已执行：
1. `sql/schema.sql` 创建表结构
2. `scripts/init_db.py` 初始化数据
3. `scripts/etl.py` 获取行情数据

---

## 技术栈

- **前端：** Next.js 16 + Shadcn UI + Sonner (Toast)
- **后端：** Python 3.8+ + Tushare
- **数据库：** Supabase (PostgreSQL)

---

## 开源协议

MIT License

## 支持与反馈

如有问题，请提交 Issue 或 Pull Request。

---

**祝交易顺利！** 📈
